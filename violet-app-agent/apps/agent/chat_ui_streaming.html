<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violet App Builder - Plan Mode</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: #1a1a2e;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        .header p { font-size: 0.9rem; opacity: 0.8; }
        .chat-area {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .message.user { align-items: flex-end; }
        .message.agent { align-items: flex-start; }
        .message-content {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.agent .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }
        .message-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 4px;
        }
        .tool-call {
            background: #e8f4fd;
            border-left: 3px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.85rem;
            border-radius: 4px;
        }
        .tool-call.success {
            background: #e8f8e8;
            border-left-color: #4caf50;
        }
        .tool-call.error {
            background: #fdecea;
            border-left-color: #e74c3c;
        }
        .plan-preview {
            background: #f5f5f5;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .plan-preview h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .plan-preview pre {
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        .progress-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .progress-step:last-child { border-bottom: none; }
        .progress-step .icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-step.pending .icon { color: #ccc; }
        .progress-step.running .icon { color: #2196f3; animation: pulse 1s infinite; }
        .progress-step.complete .icon { color: #4caf50; }
        .progress-step.error .icon { color: #e74c3c; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #5a6fd6; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status {
            text-align: center;
            padding: 10px;
            font-size: 0.85rem;
            color: #666;
        }
        .status.error { color: #e74c3c; background: #fdecea; }
        .status.success { color: #27ae60; background: #e8f8f0; }
        .status.loading { color: #2196f3; background: #e3f2fd; }
        .thinking {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-style: italic;
        }
        .thinking-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .capability-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 10px 0;
        }
        .can-do, .you-add {
            padding: 12px;
            border-radius: 8px;
        }
        .can-do {
            background: #e8f8e8;
            border: 1px solid #4caf50;
        }
        .you-add {
            background: #fff3e0;
            border: 1px solid #ff9800;
        }
        .can-do h5 { color: #2e7d32; margin-bottom: 8px; }
        .you-add h5 { color: #e65100; margin-bottom: 8px; }
        .can-do ul, .you-add ul {
            margin-left: 20px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Violet App Builder</h1>
            <p>Describe your app idea - watch it come to life</p>
        </div>

        <div id="status" class="status">
            Connecting to agent...
        </div>

        <div class="chat-area" id="chat">
            <div class="message agent">
                <span class="message-label">Violet App Builder</span>
                <div class="message-content">
                    <strong>Welcome! I build web apps from your ideas.</strong>

Tell me what you want to build. I'll show you a plan, then create it for you.

<strong>What I can build:</strong>
- Data models and APIs
- Web pages and forms
- Subdomains with admin panels

<strong>What you'll add:</strong>
- Your actual content
- Your personal style

Try: "Build a recipe app with ingredients and instructions"</div>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="input" placeholder="Describe your app idea..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" id="sendBtn">Build It</button>
        </div>
    </div>

    <script>
        const LANGGRAPH_URL = 'http://localhost:8123';
        let threadId = null;
        let currentRunId = null;

        async function checkConnection() {
            const status = document.getElementById('status');
            try {
                const response = await fetch(`${LANGGRAPH_URL}/ok`);
                if (response.ok) {
                    status.textContent = 'Connected - Ready to build';
                    status.className = 'status success';
                } else {
                    throw new Error('Not healthy');
                }
            } catch (e) {
                status.textContent = 'Agent not running. Start with: langgraph dev --port 8123';
                status.className = 'status error';
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // Build progress tracking
        let buildSteps = [];
        let currentStepIndex = 0;

        function detectBuildPhase(content) {
            // Detect if this is a Plan Preview with YAML specification
            if (content.includes('subdomain_name:') || content.includes('```yaml')) {
                return 'plan-preview';
            }
            // Detect if this is the Verify Phase with completion summary
            if (content.includes('Your') && (content.includes('is ready!') || content.includes('is LIVE!'))) {
                return 'verify-complete';
            }
            return 'normal';
        }

        function renderCapabilityCard(canBuild, youllAdd) {
            return `
                <div class="capability-card">
                    <div class="can-do">
                        <h5>What I Can Build</h5>
                        <ul>${canBuild.map(item => `<li>${item}</li>`).join('')}</ul>
                    </div>
                    <div class="you-add">
                        <h5>What You'll Add</h5>
                        <ul>${youllAdd.map(item => `<li>${item}</li>`).join('')}</ul>
                    </div>
                </div>
            `;
        }

        function renderPlanPreview(content) {
            // Extract YAML from content
            const yamlMatch = content.match(/```yaml([\s\S]*?)```/);
            if (yamlMatch) {
                const yaml = yamlMatch[1].trim();
                return `
                    <div class="plan-preview">
                        <h4>Your App Plan</h4>
                        <pre>${yaml}</pre>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="sendApproval('yes')" style="background: #4caf50;">Approve Plan</button>
                            <button onclick="sendApproval('adjust')" style="background: #ff9800;">Adjust</button>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        function sendApproval(response) {
            document.getElementById('input').value = response;
            sendMessage();
        }

        function renderBuildProgress(steps) {
            const html = steps.map((step, i) => `
                <div class="progress-step ${step.status}">
                    <span class="icon">${step.status === 'complete' ? '✓' : step.status === 'running' ? '◉' : '○'}</span>
                    <span>[${i + 1}/${steps.length}] ${step.name}</span>
                    ${step.detail ? `<small style="margin-left: auto; color: #666;">${step.detail}</small>` : ''}
                </div>
            `).join('');

            return `<div class="build-progress" style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 10px 0;">${html}</div>`;
        }

        function addMessage(content, isUser = false, options = {}) {
            const chat = document.getElementById('chat');
            const msg = document.createElement('div');
            msg.className = `message ${isUser ? 'user' : 'agent'}`;

            if (options.id) msg.id = options.id;

            let formattedContent = content;
            if (!isUser) {
                // Detect special content types
                const phase = detectBuildPhase(content);

                // Check for plan preview with YAML
                const planPreview = renderPlanPreview(content);
                if (planPreview) {
                    formattedContent = content.replace(/```yaml[\s\S]*?```/, '') + planPreview;
                }

                // Convert markdown-like formatting
                formattedContent = formattedContent
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                // Convert tables to HTML
                if (content.includes('|--')) {
                    formattedContent = formattedContent.replace(
                        /\|(.*?)\|<br>\|[-|]+\|<br>((?:\|.*?\|<br>)*)/g,
                        (match, header, rows) => {
                            const headers = header.split('|').filter(h => h.trim());
                            const headerHtml = headers.map(h => `<th style="padding: 4px 8px; border-bottom: 2px solid #667eea;">${h.trim()}</th>`).join('');
                            const rowsHtml = rows.replace(/<br>$/, '').split('<br>').map(row => {
                                const cells = row.split('|').filter(c => c.trim());
                                return `<tr>${cells.map(c => `<td style="padding: 4px 8px; border-bottom: 1px solid #eee;">${c.trim()}</td>`).join('')}</tr>`;
                            }).join('');
                            return `<table style="border-collapse: collapse; margin: 10px 0; font-size: 0.9rem;"><thead><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table>`;
                        }
                    );
                }
            }

            msg.innerHTML = `
                <span class="message-label">${isUser ? 'You' : 'Violet App Builder'}</span>
                <div class="message-content">${formattedContent}</div>
            `;

            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
            return msg;
        }

        function addThinking() {
            const chat = document.getElementById('chat');
            const msg = document.createElement('div');
            msg.className = 'message agent';
            msg.id = 'thinking-msg';
            msg.innerHTML = `
                <span class="message-label">Violet App Builder</span>
                <div class="message-content">
                    <span class="thinking">
                        Understanding your vision
                        <span class="thinking-dots">
                            <span></span><span></span><span></span>
                        </span>
                    </span>
                </div>
            `;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateThinking(text) {
            const thinkingMsg = document.getElementById('thinking-msg');
            if (thinkingMsg) {
                thinkingMsg.querySelector('.thinking').innerHTML = `
                    ${text}
                    <span class="thinking-dots">
                        <span></span><span></span><span></span>
                    </span>
                `;
            }
        }

        function removeThinking() {
            const thinkingMsg = document.getElementById('thinking-msg');
            if (thinkingMsg) thinkingMsg.remove();
        }

        function addToolCall(toolName, status, details = '') {
            const chat = document.getElementById('chat');
            const existing = document.getElementById(`tool-${toolName}`);

            const statusClass = status === 'running' ? '' : (status === 'success' ? 'success' : 'error');
            const icon = status === 'running' ? '...' : (status === 'success' ? '✓' : '✗');

            const html = `
                <div class="tool-call ${statusClass}" id="tool-${toolName}">
                    <strong>${icon} ${toolName}</strong>
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;

            if (existing) {
                existing.outerHTML = html;
            } else {
                chat.insertAdjacentHTML('beforeend', html);
            }
            chat.scrollTop = chat.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('input');
            const sendBtn = document.getElementById('sendBtn');
            const status = document.getElementById('status');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, true);
            input.value = '';
            sendBtn.disabled = true;
            status.textContent = 'Building...';
            status.className = 'status loading';

            try {
                // Create thread if needed
                if (!threadId) {
                    const threadRes = await fetch(`${LANGGRAPH_URL}/threads`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    const thread = await threadRes.json();
                    threadId = thread.thread_id;
                }

                addThinking();

                // Stream the response
                const response = await fetch(`${LANGGRAPH_URL}/threads/${threadId}/runs/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assistant_id: 'violet-app-agent',
                        input: {
                            messages: [{ role: 'user', content: message }]
                        },
                        stream_mode: ['values', 'messages']
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let lastContent = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                // Handle different event types
                                if (data.messages) {
                                    const lastMsg = data.messages[data.messages.length - 1];
                                    if (lastMsg && lastMsg.content && lastMsg.content !== lastContent) {
                                        // Check for tool calls
                                        if (lastMsg.tool_calls && lastMsg.tool_calls.length > 0) {
                                            for (const tool of lastMsg.tool_calls) {
                                                updateThinking(`Running ${tool.name}...`);
                                                addToolCall(tool.name, 'running');
                                            }
                                        } else if (lastMsg.type === 'tool') {
                                            // Tool result
                                            const preview = lastMsg.content.substring(0, 100);
                                            addToolCall(lastMsg.name || 'tool', 'success', preview);
                                        } else if (lastMsg.role === 'assistant' || lastMsg.type === 'ai') {
                                            // Final AI response
                                            removeThinking();
                                            // Handle content as string or array of content blocks
                                            let textContent = '';
                                            if (typeof lastMsg.content === 'string') {
                                                textContent = lastMsg.content;
                                            } else if (Array.isArray(lastMsg.content)) {
                                                // Extract text from content blocks
                                                textContent = lastMsg.content
                                                    .filter(block => block.type === 'text')
                                                    .map(block => block.text)
                                                    .join('\n');
                                            }
                                            if (textContent && textContent.length > 0 && textContent !== lastContent) {
                                                lastContent = textContent;
                                                addMessage(textContent);
                                            }
                                        }
                                    }
                                }
                            } catch (e) {
                                // Ignore parse errors for partial chunks
                            }
                        }
                    }
                }

                removeThinking();
                status.textContent = 'Ready';
                status.className = 'status success';

            } catch (e) {
                removeThinking();
                addMessage(`Error: ${e.message}. Check that LangGraph is running.`);
                status.textContent = 'Error - check console';
                status.className = 'status error';
            }

            sendBtn.disabled = false;
        }

        // Check connection on load
        checkConnection();
    </script>
</body>
</html>
