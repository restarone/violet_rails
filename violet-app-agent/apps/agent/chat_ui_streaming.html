<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violet App Builder - Plan Mode</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: #1a1a2e;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        .header p { font-size: 0.9rem; opacity: 0.8; }
        .chat-area {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .message.user { align-items: flex-end; }
        .message.agent { align-items: flex-start; }
        .message-content {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.agent .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }
        .message-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 4px;
        }
        .tool-call {
            background: #e8f4fd;
            border-left: 3px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.85rem;
            border-radius: 4px;
        }
        .tool-call.success {
            background: #e8f8e8;
            border-left-color: #4caf50;
        }
        .tool-call.error {
            background: #fdecea;
            border-left-color: #e74c3c;
        }
        .plan-preview {
            background: #f5f5f5;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .plan-preview h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .plan-preview pre {
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        .progress-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .progress-step:last-child { border-bottom: none; }
        .progress-step .icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-step.pending .icon { color: #ccc; }
        .progress-step.running .icon { color: #2196f3; animation: pulse 1s infinite; }
        .progress-step.complete .icon { color: #4caf50; }
        .progress-step.error .icon { color: #e74c3c; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #5a6fd6; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status {
            text-align: center;
            padding: 10px;
            font-size: 0.85rem;
            color: #666;
        }
        .status.error { color: #e74c3c; background: #fdecea; }
        .status.success { color: #27ae60; background: #e8f8f0; }
        .status.loading { color: #2196f3; background: #e3f2fd; }
        .thinking {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-style: italic;
        }
        .thinking-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .capability-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 10px 0;
        }
        .can-do, .you-add {
            padding: 12px;
            border-radius: 8px;
        }
        .can-do {
            background: #e8f8e8;
            border: 1px solid #4caf50;
        }
        .you-add {
            background: #fff3e0;
            border: 1px solid #ff9800;
        }
        .can-do h5 { color: #2e7d32; margin-bottom: 8px; }
        .you-add h5 { color: #e65100; margin-bottom: 8px; }
        .can-do ul, .you-add ul {
            margin-left: 20px;
            font-size: 0.9rem;
        }
        /* Act Phase - Build Progress */
        .build-tracker {
            background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            color: white;
        }
        .build-tracker h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .build-tracker h4 .pulse {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .build-step {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .build-step:last-child { border-bottom: none; }
        .build-step .step-number {
            background: rgba(102, 126, 234, 0.3);
            color: #a3b3ff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 12px;
            min-width: 50px;
            text-align: center;
        }
        .build-step.complete .step-number {
            background: rgba(76, 175, 80, 0.3);
            color: #a5d6a7;
        }
        .build-step.running .step-number {
            background: rgba(33, 150, 243, 0.3);
            color: #90caf9;
            animation: pulse 1s infinite;
        }
        .build-step .step-content {
            flex: 1;
        }
        .build-step .step-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        .build-step .step-detail {
            font-size: 0.85rem;
            color: #a0a0a0;
        }
        .build-step .step-icon {
            font-size: 1.2rem;
            margin-left: 10px;
        }
        .build-step.pending .step-icon { color: #666; }
        .build-step.running .step-icon { color: #2196f3; }
        .build-step.complete .step-icon { color: #4caf50; }
        .build-step.error .step-icon { color: #e74c3c; }

        /* Verify Phase - Success Summary */
        .verify-summary {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            color: white;
        }
        .verify-summary h4 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .verify-summary .resource-list {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .verify-summary .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .verify-summary .resource-item:last-child { border-bottom: none; }
        .verify-summary .resource-item a {
            color: #a5d6a7;
            text-decoration: none;
        }
        .verify-summary .resource-item a:hover {
            text-decoration: underline;
        }
        .verify-summary .next-steps {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 15px;
        }
        .verify-summary .next-steps h5 {
            margin-bottom: 10px;
            color: #c8e6c9;
        }
        .verify-summary .next-steps ul {
            margin-left: 20px;
        }
        .verify-summary .next-steps li {
            margin-bottom: 5px;
        }

        /* Plan Approval Buttons */
        .plan-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .plan-actions button {
            flex: 1;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .plan-actions .btn-approve {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
        }
        .plan-actions .btn-approve:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .plan-actions .btn-modify {
            background: white;
            color: #ff9800;
            border: 2px solid #ff9800;
        }
        .plan-actions .btn-modify:hover {
            background: #fff3e0;
        }
        .plan-actions .btn-restart {
            background: transparent;
            color: #999;
            border: 1px solid #999;
        }
        .plan-actions .btn-restart:hover {
            color: #666;
            border-color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Violet App Builder</h1>
            <p>Describe your app idea - watch it come to life</p>
        </div>

        <div id="status" class="status">
            Connecting to agent...
        </div>

        <div class="chat-area" id="chat">
            <div class="message agent">
                <span class="message-label">Violet App Builder</span>
                <div class="message-content">
                    <strong>Welcome! I build web apps from your ideas.</strong>

Tell me what you want to build. I'll show you a plan, then create it for you.

<strong>What I can build:</strong>
- Data models and APIs
- Web pages and forms
- Subdomains with admin panels

<strong>What you'll add:</strong>
- Your actual content
- Your personal style

Try: "Build a recipe app with ingredients and instructions"</div>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="input" placeholder="Describe your app idea..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" id="sendBtn">Build It</button>
        </div>
    </div>

    <script>
        const LANGGRAPH_URL = 'http://localhost:8123';
        let threadId = null;
        let currentRunId = null;

        async function checkConnection() {
            const status = document.getElementById('status');
            try {
                const response = await fetch(`${LANGGRAPH_URL}/ok`);
                if (response.ok) {
                    status.textContent = 'Connected - Ready to build';
                    status.className = 'status success';
                } else {
                    throw new Error('Not healthy');
                }
            } catch (e) {
                status.textContent = 'Agent not running. Start with: langgraph dev --port 8123';
                status.className = 'status error';
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // Build progress tracking - Act Phase State Machine
        let buildState = {
            phase: 'idle', // idle, plan, act, verify
            steps: [],
            currentStep: -1,
            resources: [],
            subdomainUrl: null,
            adminUrl: null
        };

        // Tool name to human-readable step name mapping
        const TOOL_DISPLAY_NAMES = {
            'create_subdomain': 'Creating subdomain',
            'create_namespace': 'Building data model',
            'create_page': 'Creating page',
            'diagnose_requirements': 'Analyzing requirements',
            'generate_specification': 'Generating specification',
            'trigger_deployment': 'Deploying app'
        };

        function detectBuildPhase(content) {
            // Detect if this is a Plan Preview with YAML specification
            if (content.includes('subdomain_name:') || content.includes('```yaml')) {
                buildState.phase = 'plan';
                return 'plan-preview';
            }
            // Detect if this is the Verify Phase with completion summary
            if (content.includes('Your') && (content.includes('is ready!') || content.includes('is LIVE!'))) {
                buildState.phase = 'verify';
                return 'verify-complete';
            }
            // Detect Act phase by tool calls
            if (buildState.phase === 'act') {
                return 'act-building';
            }
            return 'normal';
        }

        function renderCapabilityCard(canBuild, youllAdd) {
            return `
                <div class="capability-card">
                    <div class="can-do">
                        <h5>What I Can Build</h5>
                        <ul>${canBuild.map(item => `<li>${item}</li>`).join('')}</ul>
                    </div>
                    <div class="you-add">
                        <h5>What You'll Add</h5>
                        <ul>${youllAdd.map(item => `<li>${item}</li>`).join('')}</ul>
                    </div>
                </div>
            `;
        }

        function renderPlanPreview(content) {
            // Extract YAML from content
            const yamlMatch = content.match(/```yaml([\s\S]*?)```/);
            if (yamlMatch) {
                const yaml = yamlMatch[1].trim();

                // Parse YAML to count items for the plan summary
                const subdomainMatch = yaml.match(/subdomain_name:\s*(\S+)/);
                const namespaceCount = (yaml.match(/- name:/g) || []).length;

                return `
                    <div class="plan-preview">
                        <h4>Your App Plan</h4>
                        <pre>${yaml}</pre>
                        <div class="plan-actions">
                            <button class="btn-approve" onclick="sendApproval('Looks good! Build it.')">
                                Approve & Build
                            </button>
                            <button class="btn-modify" onclick="showModifyInput()">
                                Modify Plan
                            </button>
                            <button class="btn-restart" onclick="sendApproval('Start over')">
                                Start Over
                            </button>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        function sendApproval(response) {
            buildState.phase = 'act';
            buildState.steps = [];
            buildState.currentStep = -1;
            document.getElementById('input').value = response;
            sendMessage();
        }

        function showModifyInput() {
            const input = document.getElementById('input');
            input.value = 'Please change ';
            input.focus();
        }

        // Act Phase: Build Tracker
        function renderBuildTracker() {
            if (buildState.steps.length === 0) return '';

            const isComplete = buildState.steps.every(s => s.status === 'complete');
            const header = isComplete
                ? '<h4>Build Complete!</h4>'
                : '<h4><span class="pulse"></span> Building Your App...</h4>';

            const stepsHtml = buildState.steps.map((step, i) => {
                const icon = step.status === 'complete' ? '✓'
                    : step.status === 'running' ? '◉'
                    : step.status === 'error' ? '✗'
                    : '○';
                return `
                    <div class="build-step ${step.status}">
                        <span class="step-number">${i + 1}/${buildState.steps.length}</span>
                        <div class="step-content">
                            <div class="step-name">${step.name}</div>
                            ${step.detail ? `<div class="step-detail">${step.detail}</div>` : ''}
                        </div>
                        <span class="step-icon">${icon}</span>
                    </div>
                `;
            }).join('');

            return `<div class="build-tracker" id="build-tracker">${header}${stepsHtml}</div>`;
        }

        function addBuildStep(toolName, status = 'running', detail = '') {
            const displayName = TOOL_DISPLAY_NAMES[toolName] || toolName;

            // Check if step already exists
            const existingIndex = buildState.steps.findIndex(s => s.toolName === toolName);
            if (existingIndex >= 0) {
                buildState.steps[existingIndex].status = status;
                if (detail) buildState.steps[existingIndex].detail = detail;
            } else {
                buildState.steps.push({
                    toolName,
                    name: displayName,
                    status,
                    detail
                });
            }

            // Update or create the build tracker in the chat
            updateBuildTrackerUI();
        }

        function updateBuildTrackerUI() {
            const existing = document.getElementById('build-tracker');
            const html = renderBuildTracker();

            if (existing) {
                existing.outerHTML = html;
            } else if (html) {
                const chat = document.getElementById('chat');
                chat.insertAdjacentHTML('beforeend', html);
                chat.scrollTop = chat.scrollHeight;
            }
        }

        // Verify Phase: Success Summary
        function renderVerifySummary(content) {
            // Extract URLs from content
            const urlMatch = content.match(/http:\/\/[\w.-]+:\d+/g) || [];
            const mainUrl = urlMatch[0] || buildState.subdomainUrl || 'http://localhost:5250';
            const adminUrl = urlMatch.find(u => u.includes('/admin')) || mainUrl + '/admin';

            // Build resource list from buildState
            const resources = buildState.steps
                .filter(s => s.status === 'complete')
                .map(s => ({
                    name: s.name,
                    detail: s.detail || 'Created successfully'
                }));

            const resourcesHtml = resources.map(r => `
                <div class="resource-item">
                    <span>${r.name}</span>
                    <span>✓ ${r.detail}</span>
                </div>
            `).join('');

            return `
                <div class="verify-summary">
                    <h4>Your App is LIVE!</h4>
                    <div class="resource-list">
                        ${resourcesHtml}
                        <div class="resource-item">
                            <span>App URL</span>
                            <a href="${mainUrl}" target="_blank">${mainUrl}</a>
                        </div>
                        <div class="resource-item">
                            <span>Admin Panel</span>
                            <a href="${adminUrl}" target="_blank">${adminUrl}</a>
                        </div>
                    </div>
                    <div class="next-steps">
                        <h5>What You'll Add Next:</h5>
                        <ul>
                            <li>Your actual content and stories</li>
                            <li>Images and media</li>
                            <li>Your personal voice and style</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderBuildProgress(steps) {
            const html = steps.map((step, i) => `
                <div class="progress-step ${step.status}">
                    <span class="icon">${step.status === 'complete' ? '✓' : step.status === 'running' ? '◉' : '○'}</span>
                    <span>[${i + 1}/${steps.length}] ${step.name}</span>
                    ${step.detail ? `<small style="margin-left: auto; color: #666;">${step.detail}</small>` : ''}
                </div>
            `).join('');

            return `<div class="build-progress" style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 10px 0;">${html}</div>`;
        }

        function addMessage(content, isUser = false, options = {}) {
            const chat = document.getElementById('chat');
            const msg = document.createElement('div');
            msg.className = `message ${isUser ? 'user' : 'agent'}`;

            if (options.id) msg.id = options.id;

            let formattedContent = content;
            if (!isUser) {
                // Detect special content types
                const phase = detectBuildPhase(content);

                // Check for plan preview with YAML
                const planPreview = renderPlanPreview(content);
                if (planPreview) {
                    formattedContent = content.replace(/```yaml[\s\S]*?```/, '') + planPreview;
                }

                // Check for verify phase - add success summary
                if (phase === 'verify-complete') {
                    const verifySummary = renderVerifySummary(content);
                    formattedContent = formattedContent + verifySummary;
                    buildState.phase = 'idle'; // Reset state
                }

                // Convert markdown-like formatting
                formattedContent = formattedContent
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                // Convert tables to HTML
                if (content.includes('|--')) {
                    formattedContent = formattedContent.replace(
                        /\|(.*?)\|<br>\|[-|]+\|<br>((?:\|.*?\|<br>)*)/g,
                        (match, header, rows) => {
                            const headers = header.split('|').filter(h => h.trim());
                            const headerHtml = headers.map(h => `<th style="padding: 4px 8px; border-bottom: 2px solid #667eea;">${h.trim()}</th>`).join('');
                            const rowsHtml = rows.replace(/<br>$/, '').split('<br>').map(row => {
                                const cells = row.split('|').filter(c => c.trim());
                                return `<tr>${cells.map(c => `<td style="padding: 4px 8px; border-bottom: 1px solid #eee;">${c.trim()}</td>`).join('')}</tr>`;
                            }).join('');
                            return `<table style="border-collapse: collapse; margin: 10px 0; font-size: 0.9rem;"><thead><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table>`;
                        }
                    );
                }
            }

            msg.innerHTML = `
                <span class="message-label">${isUser ? 'You' : 'Violet App Builder'}</span>
                <div class="message-content">${formattedContent}</div>
            `;

            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
            return msg;
        }

        function addThinking() {
            const chat = document.getElementById('chat');
            const msg = document.createElement('div');
            msg.className = 'message agent';
            msg.id = 'thinking-msg';
            msg.innerHTML = `
                <span class="message-label">Violet App Builder</span>
                <div class="message-content">
                    <span class="thinking">
                        Understanding your vision
                        <span class="thinking-dots">
                            <span></span><span></span><span></span>
                        </span>
                    </span>
                </div>
            `;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateThinking(text) {
            const thinkingMsg = document.getElementById('thinking-msg');
            if (thinkingMsg) {
                thinkingMsg.querySelector('.thinking').innerHTML = `
                    ${text}
                    <span class="thinking-dots">
                        <span></span><span></span><span></span>
                    </span>
                `;
            }
        }

        function removeThinking() {
            const thinkingMsg = document.getElementById('thinking-msg');
            if (thinkingMsg) thinkingMsg.remove();
        }

        function addToolCall(toolName, status, details = '') {
            const chat = document.getElementById('chat');
            const existing = document.getElementById(`tool-${toolName}`);

            const statusClass = status === 'running' ? '' : (status === 'success' ? 'success' : 'error');
            const icon = status === 'running' ? '...' : (status === 'success' ? '✓' : '✗');

            const html = `
                <div class="tool-call ${statusClass}" id="tool-${toolName}">
                    <strong>${icon} ${toolName}</strong>
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;

            if (existing) {
                existing.outerHTML = html;
            } else {
                chat.insertAdjacentHTML('beforeend', html);
            }
            chat.scrollTop = chat.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('input');
            const sendBtn = document.getElementById('sendBtn');
            const status = document.getElementById('status');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, true);
            input.value = '';
            sendBtn.disabled = true;
            status.textContent = 'Building...';
            status.className = 'status loading';

            try {
                // Create thread if needed
                if (!threadId) {
                    const threadRes = await fetch(`${LANGGRAPH_URL}/threads`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    const thread = await threadRes.json();
                    threadId = thread.thread_id;
                }

                addThinking();

                // Stream the response
                const response = await fetch(`${LANGGRAPH_URL}/threads/${threadId}/runs/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assistant_id: 'violet-app-agent',
                        input: {
                            messages: [{ role: 'user', content: message }]
                        },
                        stream_mode: ['values', 'messages']
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let lastContent = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                // Handle different event types
                                if (data.messages) {
                                    const lastMsg = data.messages[data.messages.length - 1];
                                    if (lastMsg && lastMsg.content && lastMsg.content !== lastContent) {
                                        // Check for tool calls
                                        if (lastMsg.tool_calls && lastMsg.tool_calls.length > 0) {
                                            for (const tool of lastMsg.tool_calls) {
                                                updateThinking(`Running ${tool.name}...`);
                                                // Use build tracker for act phase tools
                                                if (buildState.phase === 'act' && TOOL_DISPLAY_NAMES[tool.name]) {
                                                    addBuildStep(tool.name, 'running');
                                                } else {
                                                    addToolCall(tool.name, 'running');
                                                }
                                            }
                                        } else if (lastMsg.type === 'tool') {
                                            // Tool result - parse for details
                                            const preview = lastMsg.content.substring(0, 100);
                                            const toolName = lastMsg.name || 'tool';

                                            // Extract useful details from result
                                            let detail = '';
                                            try {
                                                const result = JSON.parse(lastMsg.content);
                                                if (result.name) detail = result.name;
                                                if (result.slug) detail = `/${result.slug}`;
                                                if (result.subdomain_count !== undefined) detail = `${result.subdomain_count} subdomains`;
                                            } catch (e) {
                                                // Not JSON, use preview
                                                detail = preview;
                                            }

                                            // Update build tracker or tool call display
                                            if (buildState.phase === 'act' && TOOL_DISPLAY_NAMES[toolName]) {
                                                addBuildStep(toolName, 'complete', detail);
                                            } else {
                                                addToolCall(toolName, 'success', detail);
                                            }
                                        } else if (lastMsg.role === 'assistant' || lastMsg.type === 'ai') {
                                            // Final AI response
                                            removeThinking();
                                            // Handle content as string or array of content blocks
                                            let textContent = '';
                                            if (typeof lastMsg.content === 'string') {
                                                textContent = lastMsg.content;
                                            } else if (Array.isArray(lastMsg.content)) {
                                                // Extract text from content blocks
                                                textContent = lastMsg.content
                                                    .filter(block => block.type === 'text')
                                                    .map(block => block.text)
                                                    .join('\n');
                                            }
                                            if (textContent && textContent.length > 0 && textContent !== lastContent) {
                                                lastContent = textContent;
                                                addMessage(textContent);
                                            }
                                        }
                                    }
                                }
                            } catch (e) {
                                // Ignore parse errors for partial chunks
                            }
                        }
                    }
                }

                removeThinking();
                status.textContent = 'Ready';
                status.className = 'status success';

            } catch (e) {
                removeThinking();
                addMessage(`Error: ${e.message}. Check that LangGraph is running.`);
                status.textContent = 'Error - check console';
                status.className = 'status error';
            }

            sendBtn.disabled = false;
        }

        // Check connection on load
        checkConnection();
    </script>
</body>
</html>
