billables_report_plugin:
  api_namespace: time_tracker
  slug: billables-report-plugin
  label: billables_report_plugin
  enabled: true
  metadata: { 'REPORTING_EMAILS': ['test@violet-rails.com'] }
  model_definition: |
    class BillablesReportPlugin
      def initialize(parameters)  
        @external_api_client = parameters[:external_api_client]
      end

      def start
        reporting_emails = @external_api_client.metadata["REPORTING_EMAILS"]

        raise 'REPORTING_EMAILS are missing!' if reporting_emails.blank?

        time_tracker = ApiNamespace.find_by(name: 'time_tracker')
        current_time = Time.zone.now

        # Fetching total hours billed for the last 24 hours [or day: need to CONFIRM].
        time_tracker_entries_for_day = time_tracker.api_resources.where(
          "created_at >= ? AND created_at <= ?",
          current_time - 24.hours,
          current_time
        ).order(:created_at)
        # Fetching total hours billed for week to date.
        time_tracker_entries_for_week = time_tracker.api_resources.where(
          "created_at >= ? AND created_at <= ?",
          current_time.beginning_of_week.beginning_of_day,
          current_time
        ).order(:created_at)
        # Fetching total hours billed for month to date.
        time_tracker_entries_for_month = time_tracker.api_resources.where(
          "created_at >= ? AND created_at <= ?",
          current_time.beginning_of_month.beginning_of_day,
          current_time
        ).order(:created_at)

        # constructing the data in CSV format for total hours billed for the last 24 hours.
        total_hours_billed_for_day = time_tracker_entries_for_day.sum { |entry| entry.properties['how_much_time_in_hours_spent'].to_f }
        total_hours_billed_for_day_csv_string = CSV.generate do |csv|
          csv << ['', 'Total Hours', total_hours_billed_for_day]
          csv << ['', '', '']
          csv << ['Date', 'Hours', 'User', 'Client', 'Task', 'Notes']
          time_tracker_entries_for_day.each do |entry|
            csv << [
              entry.created_at.to_s,
              entry.properties['how_much_time_in_hours_spent'].to_f,
              entry.properties['email_address'] || entry.user&.email,
              entry.properties['for_what_client'],
              entry.properties['what_task_did_you_work_on'],
              entry.properties['notes']
            ]
          end
        end

        # constructing the data in CSV format for total hours billed for the week to date.
        total_hours_billed_for_week = time_tracker_entries_for_week.sum { |entry| entry.properties['how_much_time_in_hours_spent'].to_f }
        total_hours_billed_for_week_csv_string = CSV.generate do |csv|
          csv << ['', 'Total Hours', total_hours_billed_for_week]
          csv << ['', '', '']
          csv << ['Date', 'Hours', 'User', 'Client', 'Task', 'Notes']
          time_tracker_entries_for_week.each do |entry|
            csv << [
              entry.created_at.to_s,
              entry.properties['how_much_time_in_hours_spent'].to_f,
              entry.properties['email_address'] || entry.user&.email,
              entry.properties['for_what_client'],
              entry.properties['what_task_did_you_work_on'],
              entry.properties['notes']
            ]
          end
        end

        # constructing the data in CSV format for total hours billed for the month to date.
        total_hours_billed_for_month = time_tracker_entries_for_month.sum { |entry| entry.properties['how_much_time_in_hours_spent'].to_f }
        total_hours_billed_for_month_csv_string = CSV.generate do |csv|
          csv << ['', 'Total Hours', total_hours_billed_for_month]
          csv << ['', '', '']
          csv << ['Date', 'Hours', 'User', 'Client', 'Task', 'Notes']
          time_tracker_entries_for_month.each do |entry|
            csv << [
              entry.created_at.to_s,
              entry.properties['how_much_time_in_hours_spent'].to_f,
              entry.properties['email_address'] || entry.user&.email,
              entry.properties['for_what_client'],
              entry.properties['what_task_did_you_work_on'],
              entry.properties['notes']
            ]
          end
        end
      
        # Creating attachment for total hours billed for the last 24 hours
        total_hours_billed_for_day_attachment_details = {
          filename: "total_hours_billed_for_day(#{current_time - 24.hours} TO #{current_time}).csv",
          mime_type: 'text/csv',
          content: total_hours_billed_for_day_csv_string.html_safe
        }
        total_hours_billed_for_day_blob = ActiveStorage::Blob.create_and_upload!(
          io: StringIO.new(total_hours_billed_for_day_attachment_details[:content]),
          filename: total_hours_billed_for_day_attachment_details[:filename],
          content_type: total_hours_billed_for_day_attachment_details[:mime_type],
          metadata: nil
        )
        total_hours_billed_for_day_blob_content = ActionText::Content.new("<action-text-attachment sgid='#{total_hours_billed_for_day_blob.attachable_sgid}'></action-text-attachment>").to_s

        # Creating attachment for total hours billed for week to date
        total_hours_billed_for_week_attachment_details = {
          filename: "total_hours_billed_for_week(#{current_time.beginning_of_week.beginning_of_day} TO #{current_time}).csv",
          mime_type: 'text/csv',
          content: total_hours_billed_for_week_csv_string.html_safe
        }
        total_hours_billed_for_week_blob = ActiveStorage::Blob.create_and_upload!(
          io: StringIO.new(total_hours_billed_for_week_attachment_details[:content]),
          filename: total_hours_billed_for_week_attachment_details[:filename],
          content_type: total_hours_billed_for_week_attachment_details[:mime_type],
          metadata: nil
        )
        total_hours_billed_for_week_blob_content = ActionText::Content.new("<action-text-attachment sgid='#{total_hours_billed_for_week_blob.attachable_sgid}'></action-text-attachment>").to_s

        # Creating attachment for total hours billed for month to date
        total_hours_billed_for_month_attachment_details = {
          filename: "total_hours_billed_for_month(#{current_time.beginning_of_month.beginning_of_day} TO #{current_time}).csv",
          mime_type: 'text/csv',
          content: total_hours_billed_for_month_csv_string.html_safe
        }
        total_hours_billed_for_month_blob = ActiveStorage::Blob.create_and_upload!(
          io: StringIO.new(total_hours_billed_for_month_attachment_details[:content]),
          filename: total_hours_billed_for_month_attachment_details[:filename],
          content_type: total_hours_billed_for_month_attachment_details[:mime_type],
          metadata: nil
        )
        total_hours_billed_for_month_blob_content = ActionText::Content.new("<action-text-attachment sgid='#{total_hours_billed_for_month_blob.attachable_sgid}'></action-text-attachment>").to_s


        # Building Email details
        subject = "Report of hours logged generated at: #{current_time}"
        email_content = <<-HTML
        <div class='trix-content'>
          <div>Please find the reports for hours logged below;<br><br>
          </div>
          <ul>
            <li>Total hours logged for today<br>#{total_hours_billed_for_day_blob_content}
            </li>
            <li>Total hours logged for this week to date<br>#{total_hours_billed_for_week_blob_content}
            </li>
            <li>Total hours logged for this month to date<br>#{total_hours_billed_for_month_blob_content}
            </li>
          </ul>
        </div>
        HTML

        # Sending email report
        email_thread = MessageThread.create!(recipients: [reporting_emails], subject: subject)
        email_message = email_thread.messages.create!(
          content: email_content.html_safe,
          attachments: [
            total_hours_billed_for_day_blob,
            total_hours_billed_for_week_blob,
            total_hours_billed_for_month_blob
          ]
        )
      end
    end
    # at the end of the file we have to implicitly return the class 
    BillablesReportPlugin